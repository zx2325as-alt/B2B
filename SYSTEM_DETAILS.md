# BtB 深度对话理解与个性化翻译系统 - 功能详解文档

本文档详细描述了 BtB (Behind the Background) 系统的当前功能架构、核心模块细节及业务逻辑。

## 1. 系统概览

BtB 是一个集成了深度自然语言理解 (NLU)、动态角色模拟、实时对话交互和后台管理分析的综合系统。它旨在通过 AI 模拟真实的人物心理、行为和交互，提供沉浸式的对话体验和深度的人物分析工具。

**核心技术栈**:
- **前端**: Streamlit (用于 Chat UI 和 Admin Dashboard)
- **后端**: FastAPI (提供 RESTful API)
- **数据存储**: SQL Database (SQLite/PostgreSQL) + SQLAlchemy ORM
- **AI 引擎**: 基于 LLM (Large Language Model) 的对话生成与意图分析

---

## 2. 核心功能模块

### 2.1 实时对话交互系统 (`chat_ui.py`)

前端用户界面，提供沉浸式的对话体验。

*   **角色扮演与发言人选择**:
    *   用户可以扮演 "User" (我) 或系统中的任意 "Character"。
    *   **"Who is speaking?" 选择器**: 允许用户指定当前输入的发言人身份。系统会根据所选身份调整上下文理解。
    *   **上下文自动绑定**: 切换发言人会自动更新后端的会话上下文 (`session_id`, `current_character_id`)。

*   **流式响应 (Streaming Response)**:
    *   对话回复采用流式输出，模拟真实打字/思考过程。
    *   **思维链展示**: 后端返回的 `thinking_process` 会被优先展示，让用户看到 AI 的推理过程。
    *   **意图与潜台词分析**: 除了回复内容，系统还会展示 AI 分析出的“意图 (Intent)”、“潜台词 (Subtext)”和“心理状态 (Psychological Profile)”。

*   **反馈机制**:
    *   用户可以对每一条 AI 回复进行评分 (1-5分) 和文字反馈。
    *   支持“是否准确”的二元反馈，用于快速校准 AI 表现。

### 2.2 后台管理看板 (`Admin_Dashboard.py`)

系统管理员和创作者的核心工作台，包含多个功能模块。

#### Tab 1: 场景管理 (Scenario Management)
*   **功能**: 创建和查看对话场景。
*   **字段**: 场景名称、所属领域、描述、规则配置 (JSON)。
*   **用途**: 定义对话发生的背景环境，影响 AI 的回复风格和限制条件。

#### Tab 2: 角色管理 (Character Management) - *核心功能*
*   **角色 CRUD**: 创建、读取、更新、删除角色档案。
*   **导入/导出**:
    *   **模板下载**: 提供标准的角色 JSON 模板下载。
    *   **JSON 导入**: 支持批量或单体导入角色 JSON 数据。
*   **六维深度档案 (6-Dimension Profile)**:
    1.  **基础属性 (Attributes)**: 年龄、职业、身份标签、成长经历、客观边界。
    2.  **表层行为 (Behavior)**: 行为模式、沟通风格。
    3.  **情绪特征 (Emotion)**: 情绪基线、情绪触发点。
    4.  **认知决策 (Cognition)**: 决策逻辑、世界观。
    5.  **人格特质 (Traits)**: 核心性格、特质倾向、三观底色、行为一致性。
    6.  **核心本质 (Core)**: 核心驱动力、深层需求、动机来源、行为底线。
*   **动态展示**: 使用 Tab 页签结构化展示上述六维数据。
*   **版本控制与对比**:
    *   记录角色档案的历史版本。
    *   **版本对比**: 在选择历史版本时，动态展示与当前版本的差异 (Diff View)。
*   **人物弧光 (Character Arc)**:
    *   以时间轴形式展示角色的关键事迹 (Timeline Events)。
    *   倒序排列，支持手动添加或通过对话分析自动生成。

#### Tab 3: 关系管理 (Relationship Management)
*   **可视化图谱**: 使用 Graphviz 渲染角色间的关系网络。
*   **关系编辑**: 定义源角色、目标角色、关系类型、强度、情感倾向及详细备注。

#### Tab 4: 核心监控 (Monitoring)
*   **对话日志**: 查看所有会话的历史记录、评分和反馈。
*   **人工干预**: 管理员可以对历史对话进行二次评分和修正。

#### Tab 5: 待处理建议 (Suggestions)
*   **观察队列**: 系统在对话过程中自动生成的“角色观察建议”。
*   **审核流程**: 管理员可以“采纳 (Approve)”或“拒绝 (Reject)”这些建议。采纳后，建议内容会自动合并入角色档案。

#### Tab 6: 长对话深度分析与归档 (Long Conversation Analysis)
*   **一键总结与更新**:
    *   输入一段长文本 (小说、剧本、聊天记录)。
    *   **自动角色识别**: 系统自动识别文本中的角色 (默认选中当前会话角色)。
    *   **深度分析**: AI 分析文本中的意图、策略、情绪及**档案更新建议**。
    *   **迭代更新 (Iterative Merge)**: 点击归档时，系统采用“深度合并 (Deep Merge)”策略，将新提取的信息增量更新到角色档案中，避免覆盖已有信息。

---

## 3. 关键业务逻辑细节

### 3.1 深度合并策略 (Deep Merge Strategy)
在更新角色档案时，为了防止新信息覆盖旧信息导致数据丢失，系统实现了递归合并逻辑：
*   **字典 (Dict)**: 递归遍历键值对进行更新。
*   **列表 (List)**: 采用集合去重追加 (Append & Deduplicate) 的方式，保留旧有的条目，添加新的条目。
*   **基础类型**: 新值覆盖旧值。

### 3.2 角色上下文绑定
*   前端的 `current_character_id` 与后端的 `session.character_id` 保持实时同步。
*   在“长对话分析”中，默认预选当前会话的角色，减少用户操作。

### 3.3 意图理解与路由
*   **NLU 引擎**: 对用户输入进行初步分类 (闲聊、指令、系统操作)。
*   **流式生成**: 使用生成器模式 (`yield`) 分段返回 NLU 分析结果和最终回复，提升用户感知的响应速度。

---

## 4. 文件结构说明

*   `app/web/chat_ui.py`: 用户聊天主界面。
*   `app/web/pages/Admin_Dashboard.py`: 后台管理系统主程序。
*   `app/api/v1/endpoints.py`: 核心 API 路由实现。
*   `app/services/character_service.py`: 角色数据操作服务。
*   `app/services/dialogue.py`: 对话生成服务 (LLM 交互)。
*   `app/core/config.py`: 系统配置。
